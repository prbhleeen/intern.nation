<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Apply for Drive | intern.nation</title>

  <link rel="stylesheet" href="../css/student_dashboard.css">
  <link rel="stylesheet" href="../css/application-form.css">
  <link rel="icon" type="image/jpeg" href="../assets/logo.jpeg">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>

<body>

<header>
    <h1 class="logo">
        <img src="../assets/logo.jpeg" alt="Logo">
        <span class="logo-text"><span>intern.</span><span>nation</span></span>
    </h1>
    <nav class="main-nav">
        <ul>
            <li><a href="student_dashboard.html">Back to Dashboard</a></li>
            <li><a href="myprofile.html">My Profile</a></li>
        </ul>
    </nav>
</header>

<section id="applicationForm" class="application-form">
  <h3>Apply for Drive</h3>

  <p><strong>Company:</strong> <span id="companyName"></span></p>
  <p><strong>Role:</strong> <span id="jobTitle"></span></p>
  <p><strong>Location:</strong> <span id="location"></span></p>

  <hr><br>

  <form id="jobApplicationForm">

    <div class="form-group">
      <label>Your Name</label>
      <input type="text" id="fullName" readonly>
    </div>

    <div class="form-group">
      <label>Email</label>
      <input type="email" id="email" readonly>
    </div>

    <div class="form-group">
      <label>Department</label>
      <input type="text" id="department" readonly>
    </div>

    <div class="form-group">
      <label>Upload Resume</label>
      <input type="file" id="resume" accept=".pdf,.doc,.docx" required>
    </div>

    <div class="form-group">
      <label>Cover Letter</label>
      <textarea id="coverLetter" rows="4"></textarea>
    </div>

    <button type="submit" class="submit-btn">Submit Application</button>
  </form>
</section>

<footer>
    <div class="footer-links">
        <p><b>Contact:</b> contact@intern.nation</p>
        <p><b>Support:</b> support@intern.nation</p>
        <p><b>Address:</b> Turing Block, Chitkara University</p>
    </div>
</footer>


<script>
  // -------------------------
  // 1️⃣ Validate student login
  // -------------------------
  const student = JSON.parse(localStorage.getItem("userInfo"));
  if (!student || student.role !== "student") {
    window.location.href = "../login.html";
  }

  // Autofill student details
  document.getElementById("fullName").value = student.name;
  document.getElementById("email").value = student.email;
  document.getElementById("department").value = student.department || "N/A";

  // -------------------------
  // 2️⃣ Get driveId from URL
  // -------------------------
  const params = new URLSearchParams(window.location.search);
  const driveId = params.get("driveId");

  // -------------------------
  // 3️⃣ Fetch drive details
  // -------------------------
  async function loadDrive() {
    const res = await fetch("http://localhost:5000/api/drives");
    const drives = await res.json();
    const drive = drives.find(d => d.id == driveId);

    if (!drive) {
      alert("Drive not found");
      return;
    }

    document.getElementById("companyName").textContent = drive.companyName;
    document.getElementById("jobTitle").textContent = drive.jobTitle;
    document.getElementById("location").textContent = drive.locationType;
  }

  loadDrive();

  // -------------------------
  // 4️⃣ Submit Application
  // -------------------------
  document.getElementById("jobApplicationForm").addEventListener("submit", async (e) => {
    e.preventDefault();

    const applicationData = {
      id: Date.now(),
      driveId: driveId,
      studentId: student.id,
      companyName: document.getElementById("companyName").textContent,
      jobTitle: document.getElementById("jobTitle").textContent,
      resume: document.getElementById("resume").value.split("\\").pop(), // filename only
      coverLetter: document.getElementById("coverLetter").value,
      status: "Applied",
      appliedOn: new Date().toISOString()
    };

    try {
      const response = await fetch("http://localhost:5000/api/applications", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(applicationData),
      });

      const result = await response.json();

      if (!response.ok) {
        alert(result.message);
        return;
      }

      alert("Application submitted successfully!");
      window.location.href = "applications.html";

    } catch (err) {
      alert("Error submitting application.");
      console.error(err);
    }
  });
</script>

</body>
</html>
